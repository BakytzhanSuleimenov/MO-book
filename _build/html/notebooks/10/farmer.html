
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Farmerâ€™s problem and some of its variants &#8212; Companion Notebooks for Data-Driven Mathematical Optimization in Python</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Pyomo Style Guide" href="../../pyomo_style_guide.html" />
    <link rel="prev" title="Airline seat allocation problem" href="airline-seating.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DVQ7NZ8CYZ"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-DVQ7NZ8CYZ');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo-02.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Companion Notebooks for Data-Driven Mathematical Optimization in Python</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Data-Driven Mathematical Optimization in Python
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01/01.00.html">
   1. Mathematical Optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01/pop-up_shop.html">
     Maximizing the profit of a pop-up shop
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02/02.00.html">
   2. Linear Optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/BIM.html">
     A first LP example: the microchip production problem of the BIM company
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/LAD-regression.html">
     Least Absolute Deviation (LAD) Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/MAD-portfolio-optimization.html">
     Mean Absolute Deviation (MAD) portfolio optimization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/L1-regression-wine-quality.html">
     L1 regression for wine quality prediction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/BIM-maxmin.html">
     A variant of the BIM problem: maximizing the lowest possible profit
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/BIM-fractional.html">
     Two variants of the BIM problem: fractional objective and additional fixed costs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/BIM-rawmaterialplanning.html">
     Optimal raw material acquisition planning for BIM based on demand forecasts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/multiproductionfaciliity_worstcase.html">
     Extra material: Multi-product facility production problem
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../03/03.00.html">
   3. Mixed Integer Linear Programming
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/cryptarithms.html">
     Cryptarithms: Send More Money
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/strip-packing.html">
     Strip Packing: Placing Boxes on a Shelf
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/simple-production-model-gdp.html">
     Production Model with Disjunctions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/recharging-electric-vehicle.html">
     Recharging Strategy for an Electric Vehicle
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/Shift-Scheduling.html">
     Shift Scheduling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/machine-scheduling.html">
     Machine Scheduling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/job-shop-scheduling.html">
     Job Shop Scheduling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/maintenance-planning.html">
     Maintenance Planning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/large-example-chapter-3.html">
     BIM Production
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../04/04.00.html">
   4. Network Optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/dina-tables-and-variations.html">
     Dinaâ€™s table seating arrangements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/Transportation.html">
     Transportation and Allocation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/forex-arbitrage.html">
     Forex Arbitrage
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/cryptocurrency-arbitrage.html">
     Crypto Currency Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/shortest-path-road-networks.html">
     Computing a real life shortest path
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/complete-example-ch4-power-network.html">
     Energy dispatch problem
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../05/05.00.html">
   5. Convex Optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../05/milk-pooling.html">
     Pooling and Blending
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05/ols-regression.html">
     Ordinary Least Squares (OLS) Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05/markowitz_portfolio_with_chance_constraint.html">
     Portfolio optimization with chance constraint
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05/refinery-production.html">
     Refinery Production and Shadow Pricing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05/svm-linear.html">
     Support Vector Machines for Binary Classifcation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../06/06.00.html">
   6. Conic Optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../06/economic-order-quantity.html">
     Economic Order Quantity
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../07/07.00.html">
   7. Accounting for Uncertainty: Optimization Meets Reality
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../07/Caroline-robustness-analysis.html">
     Caroline on robust steroids
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../08/08.00.html">
   8. Robust Optimization - Single Stage Problems
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../08/ef-robust-optimization.html">
     Companion notebook to EFâ€™s training on optimization with data uncertainty
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../09/09.00.html">
   9. Stochastic Optimization - Single Stage Problems
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../09/newsvendor.html">
     Stock optimization for seafood distribution center
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="10.00.html">
   10. Two Stage Problems
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="airline-seating.html">
     Airline seat allocation problem
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Farmerâ€™s problem and some of its variants
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../pyomo_style_guide.html">
   Pyomo Style Guide
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/mobook/MO-book/main?urlpath=tree/notebooks/10/farmer.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/mobook/MO-book/blob/main/notebooks/10/farmer.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/mobook/MO-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/mobook/MO-book/issues/new?title=Issue%20on%20page%20%2Fnotebooks/10/farmer.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/notebooks/10/farmer.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#base-model">
   Base Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scenario-dependent-prices">
   Scenario Dependent Prices
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-discrete-first-stage-decisions">
   (c) Discrete First-Stage Decisions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#d-risk-averse-farmer">
   (d) Risk Averse Farmer
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Farmerâ€™s problem and some of its variants</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#base-model">
   Base Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scenario-dependent-prices">
   Scenario Dependent Prices
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-discrete-first-stage-decisions">
   (c) Discrete First-Stage Decisions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#d-risk-averse-farmer">
   (d) Risk Averse Farmer
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="farmer-s-problem-and-some-of-its-variants">
<h1>Farmerâ€™s problem and some of its variants<a class="headerlink" href="#farmer-s-problem-and-some-of-its-variants" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># install Pyomo and solvers</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/mobook/MO-book/main/python/helper.py&quot;</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="s2">&quot;helper&quot;</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">helper</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

<span class="n">helper</span><span class="o">.</span><span class="n">install_pyomo</span><span class="p">()</span>
<span class="n">helper</span><span class="o">.</span><span class="n">install_glpk</span><span class="p">()</span>
<span class="n">helper</span><span class="o">.</span><span class="n">install_cbc</span><span class="p">()</span>
<span class="n">helper</span><span class="o">.</span><span class="n">install_ipopt</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pyomo was previously installed
glpk was previously installed
cbc was previously installed
ipopt was previously installed
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">pyomo.environ</span> <span class="k">as</span> <span class="nn">pyo</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Markdown</span>

<span class="n">cbc_solver</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;cbc&#39;</span><span class="p">)</span>
<span class="n">glpk_solver</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;glpk&#39;</span><span class="p">)</span>
<span class="n">ipopt_solver</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="base-model">
<h2>Base Model<a class="headerlink" href="#base-model" title="Permalink to this headline">#</a></h2>
<p>In the <a class="reference external" href="https://www.math.uh.edu/~rohop/Spring_15/Chapter1.pdf">farmerâ€™s problem</a> a farmer has to allocate <span class="math notranslate nohighlight">\(500\)</span> acres of land to three different types of crops aiming to maximize her profit.</p>
<p>Recall that:</p>
<ul class="simple">
<li><p>Planting one acre of wheat, corn and beet costs 150, 230 and 260 euro, respectively.</p></li>
<li><p>At least 200 tons of wheat and 240 tons of corn are needed for cattle feed, which can be purchased from a wholesaler if not harvested by her farm.</p></li>
<li><p>Up to 6,000 tons of sugar beets can be sold for 36 euro per ton, while any additional amounts can be sold for 10 euro per ton.</p></li>
<li><p>Any wheat or corn not used for the cattle can be sold at 170 euro and 150 euro per ton of wheat and corn, respectively. The wholesaler sells the wheat or corn at a higher price, namely 238 euro and 210 euro per ton, respectively.</p></li>
</ul>
<p>In her decision, the farmer considers three weather scenarios, each one having a different yield in tons/acre per crop type as summarized by the following table.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Scenario</p></th>
<th class="text-align:center head"><p>Yield for wheat <br> (tons/acre)</p></th>
<th class="text-align:center head"><p>Yield for corn <br> (tons/acre)</p></th>
<th class="text-align:center head"><p>Yield for beets <br> (tons/acre)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Good weather</p></td>
<td class="text-align:center"><p>3</p></td>
<td class="text-align:center"><p>3.6</p></td>
<td class="text-align:center"><p>24</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Average weather</p></td>
<td class="text-align:center"><p>2.5</p></td>
<td class="text-align:center"><p>3</p></td>
<td class="text-align:center"><p>20</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Bad weather</p></td>
<td class="text-align:center"><p>2</p></td>
<td class="text-align:center"><p>2.4</p></td>
<td class="text-align:center"><p>16</p></td>
</tr>
</tbody>
</table>
<p>We first consider the case in which all the prices are fixed and not weather-dependent. The following table summarizes the data.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Commodity</p></th>
<th class="text-align:center head"><p>Sell Price <br> (euro/ton)</p></th>
<th class="text-align:center head"><p>Market <br> Demand <br> (tons)</p></th>
<th class="text-align:center head"><p>Purchase <br> Price <br> (euro/ton)</p></th>
<th class="text-align:center head"><p>Cattle Feed <br> Required <br> (tons)</p></th>
<th class="text-align:center head"><p>Planting <br> Cost <br> (euro/acre)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Wheat</p></td>
<td class="text-align:center"><p>170</p></td>
<td class="text-align:center"><p>-</p></td>
<td class="text-align:center"><p>238</p></td>
<td class="text-align:center"><p>200</p></td>
<td class="text-align:center"><p>150</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Corn</p></td>
<td class="text-align:center"><p>150</p></td>
<td class="text-align:center"><p>-</p></td>
<td class="text-align:center"><p>210</p></td>
<td class="text-align:center"><p>240</p></td>
<td class="text-align:center"><p>230</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Beets</p></td>
<td class="text-align:center"><p>36</p></td>
<td class="text-align:center"><p>6000</p></td>
<td class="text-align:center"><p>-</p></td>
<td class="text-align:center"><p>0</p></td>
<td class="text-align:center"><p>260</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Beets extra</p></td>
<td class="text-align:center"><p>10</p></td>
<td class="text-align:center"><p>-</p></td>
<td class="text-align:center"><p>-</p></td>
<td class="text-align:center"><p>0</p></td>
<td class="text-align:center"><p>260</p></td>
</tr>
</tbody>
</table>
<p>(a) Implement the extensive form of stochastic LP corresponding to the farmerâ€™s problem in Pyomo and solve it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">crop,        planting_cost, crop_yield, sell_price, demand, buy_price, cattle_feed</span>
<span class="s2">wheat,                 150,        2.5,        170,       ,       238,         200</span>
<span class="s2">corn,                  230,          3,        150,       ,       210,         240  </span>
<span class="s2">beets,                 260,         20,         36,   6000,          ,           0</span>
<span class="s2">beets extra,           260,         </span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># constant parameters</span>
<span class="n">planting_cost</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">230</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">260</span><span class="p">,</span> <span class="s2">&quot;B extra&quot;</span><span class="p">:</span> <span class="mi">260</span><span class="p">}</span>
<span class="n">crop_yield</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;B extra&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
<span class="n">sell_price</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="mi">170</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span> <span class="s2">&quot;B extra&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
<span class="n">demand</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">6000</span><span class="p">,</span> <span class="s2">&quot;B extra&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">}</span>
<span class="n">buy_price</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="mi">238</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">210</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="s2">&quot;B extra&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">}</span>
<span class="n">cattle_feed</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">240</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B extra&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="c1"># scenario dependent parameters</span>
<span class="n">yield_factor</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="c1"># mutable parameter</span>
<span class="n">m</span><span class="o">.</span><span class="n">total_acres</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># sets</span>
<span class="n">m</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">planting_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">m</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">yield_factor</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># constant parameter values</span>
<span class="n">m</span><span class="o">.</span><span class="n">planting_cost</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">planting_cost</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">crop_yield</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">crop_yield</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell_price</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">sell_price</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">buy_price</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">buy_price</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">demand</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">demand</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">cattle_feed</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">cattle_feed</span><span class="p">)</span>

<span class="c1"># scenario dependent parameter values</span>
<span class="n">m</span><span class="o">.</span><span class="n">yield_factor</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">yield_factor</span><span class="p">)</span>

<span class="c1"># first stage variables</span>

<span class="n">m</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># first stage constraint</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">acres</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">total_acres</span>

<span class="c1"># first stage profit</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Expression</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">planting_cost</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>

<span class="c1"># second stage variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">produced</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">buy</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">crops_produced</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">crop_yield</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">yield_factor</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">demand_limit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">cattle_feed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>

<span class="c1"># second stage profit</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">sell_price</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span> 
    <span class="n">expense</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">buy_price</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revenue</span> <span class="o">-</span> <span class="n">expense</span>

<span class="c1"># Objective</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">second_stage_profit</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>

<span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;cbc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First Stage Profit: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Crop       Planted&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">           (acres)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Second Stage / Recourse Solutions&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scenario </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> Profit: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">second_stage_profit</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Crop      Produced       Buy      Feed      Sell&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">            (tons)     (tons)    (tons)   (tons)&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
        <span class="n">sout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">cattle_feed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sout</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Expected profit = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">total_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First Stage Profit: -108900.00 euros
	Crop       Planted
	           (acres)
	W            170.0
	C             80.0
	B            250.0
	B extra        0.0

Second Stage / Recourse Solutions

Scenario H Profit: 275900.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            510.0       0.0     200.0     310.0
	C            288.0       0.0     240.0      48.0
	B           6000.0       0.0       0.0    6000.0
	B extra        0.0       0.0       0.0       0.0

Scenario M Profit: 218250.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            425.0       0.0     200.0     225.0
	C            240.0       0.0     240.0       0.0
	B           5000.0       0.0       0.0    5000.0
	B extra        0.0       0.0       0.0       0.0

Scenario L Profit: 157720.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            340.0       0.0     200.0     140.0
	C            192.0      48.0     240.0       0.0
	B           4000.0       0.0       0.0    4000.0
	B extra        0.0       0.0       0.0       0.0

Expected profit = 108390.00 euros
</pre></div>
</div>
</div>
</div>
</section>
<section id="scenario-dependent-prices">
<h2>Scenario Dependent Prices<a class="headerlink" href="#scenario-dependent-prices" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># second stage constraints</span>
<span class="nd">@model</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">feed_cattle_W</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span>

<span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">first_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">total_H</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="n">total_M</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="n">total_L</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">total_H</span> <span class="o">+</span> <span class="n">total_M</span> <span class="o">+</span> <span class="n">total_L</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span>

<span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">second_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span>

<span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">total_profit</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">cbc_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solver status:** *</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solution:**&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(land allocation) $x_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action high yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action high yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action medium yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action medium yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action low yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action low yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Maximizes objective value to:** $</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Implicitly replacing the Component attribute feed_cattle_W
    (type=&lt;class &#39;pyomo.core.base.constraint.IndexedConstraint&#39;&gt;) on block
    unknown with a new Component (type=&lt;class
    &#39;pyomo.core.base.constraint.IndexedConstraint&#39;&gt;). This is usually
    indicative of a modelling error. To avoid this warning, use
    block.del_component() and block.add_component().
ERROR: Rule failed when generating expression for Constraint feed_cattle_W
    with index H: AttributeError: &#39;ConcreteModel&#39; object has no attribute
    &#39;plant&#39;
ERROR: Constructing component &#39;feed_cattle_W&#39; from data=None failed:
    AttributeError: &#39;ConcreteModel&#39; object has no attribute &#39;plant&#39;
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="nn">Input In [202],</span> in <span class="ni">&lt;cell line: 2&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># second stage constraints</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="nd">@model</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="k">def</span> <span class="nf">feed_cattle_W</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>

<span class="nn">File ~/opt/anaconda3/lib/python3.9/site-packages/pyomo/core/base/block.py:67,</span> in <span class="ni">_generic_component_decorator.__call__</span><span class="nt">(self, rule)</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">67</span>     <span class="nb">setattr</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">68</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span>         <span class="n">rule</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_component</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwds</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">71</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">72</span>     <span class="k">return</span> <span class="n">rule</span>

<span class="nn">File ~/opt/anaconda3/lib/python3.9/site-packages/pyomo/core/base/block.py:572,</span> in <span class="ni">_BlockData.__setattr__</span><span class="nt">(self, name, val)</span>
<span class="g g-Whitespace">    </span><span class="mi">563</span>     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">564</span>         <span class="s2">&quot;Implicitly replacing the Component attribute &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">565</span>         <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (type=</span><span class="si">%s</span><span class="s2">) on block </span><span class="si">%s</span><span class="s2"> with a new Component (type=</span><span class="si">%s</span><span class="s2">).&quot;</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">569</span>         <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">570</span>            <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
<span class="g g-Whitespace">    </span><span class="mi">571</span>     <span class="bp">self</span><span class="o">.</span><span class="n">del_component</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">572</span>     <span class="bp">self</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">574</span>     <span class="c1">#</span>
<span class="g g-Whitespace">    </span><span class="mi">575</span>     <span class="c1"># The incoming value is not a component, so we set the</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">582</span>     <span class="c1"># generated while setting the value.</span>
<span class="g g-Whitespace">    </span><span class="mi">583</span>     <span class="c1">#</span>
<span class="g g-Whitespace">    </span><span class="mi">584</span>     <span class="k">try</span><span class="p">:</span>

<span class="nn">File ~/opt/anaconda3/lib/python3.9/site-packages/pyomo/core/base/block.py:1087,</span> in <span class="ni">_BlockData.add_component</span><span class="nt">(self, name, val)</span>
<span class="g g-Whitespace">   </span><span class="mi">1083</span>     <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Constructing </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2">&#39; on </span><span class="si">%s</span><span class="s2"> from data=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1084</span>                  <span class="n">val</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1085</span>                  <span class="n">_blockName</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="g g-Whitespace">   </span><span class="mi">1086</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1087</span>     <span class="n">val</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1088</span> <span class="k">except</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1089</span>     <span class="n">err</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

<span class="nn">File ~/opt/anaconda3/lib/python3.9/site-packages/pyomo/core/base/constraint.py:748,</span> in <span class="ni">Constraint.construct</span><span class="nt">(self, data)</span>
<span class="g g-Whitespace">    </span><span class="mi">745</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">746</span>         <span class="c1"># Bypass the index validation and create the member directly</span>
<span class="g g-Whitespace">    </span><span class="mi">747</span>         <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_set</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">748</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_setitem_when_not_present</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">rule</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">749</span> <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">750</span>     <span class="n">err</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

<span class="nn">File ~/opt/anaconda3/lib/python3.9/site-packages/pyomo/core/base/initializer.py:252,</span> in <span class="ni">IndexedCallInitializer.__call__</span><span class="nt">(self, parent, idx)</span>
<span class="g g-Whitespace">    </span><span class="mi">250</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">252</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fcn</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

<span class="nn">Input In [202],</span> in <span class="ni">feed_cattle_W</span><span class="nt">(model, s)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="nd">@model</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="k">def</span> <span class="nf">feed_cattle_W</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">4</span>     <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span>

<span class="nn">File ~/opt/anaconda3/lib/python3.9/site-packages/pyomo/core/base/block.py:522,</span> in <span class="ni">_BlockData.__getattr__</span><span class="nt">(self, val)</span>
<span class="g g-Whitespace">    </span><span class="mi">518</span>     <span class="k">return</span> <span class="n">_component_decorator</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">519</span>         <span class="bp">self</span><span class="p">,</span> <span class="n">ModelComponentFactory</span><span class="o">.</span><span class="n">get_class</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">520</span> <span class="c1"># Since the base classes don&#39;t support getattr, we can just</span>
<span class="g g-Whitespace">    </span><span class="mi">521</span> <span class="c1"># throw the &quot;normal&quot; AttributeError</span>
<span class="ne">--&gt; </span><span class="mi">522</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">523</span>                      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

<span class="ne">AttributeError</span>: &#39;ConcreteModel&#39; object has no attribute &#39;plant&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">totalacres</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="c1"># to obtain the yields in the good weather (high yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># to obtain the yields in the bad weather (low yield) case by multiplying the average ones</span>

<span class="c1"># first stage variables</span>
<span class="n">model</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

<span class="c1"># first stage constraint</span>
<span class="nd">@model</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">total_acres</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">summation</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">totalacres</span>

<span class="n">model</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">])</span>  <span class="c1"># high, medium, and low yield scenarios</span>

<span class="c1"># second stage variables (labelled as H, M, L depending on the scenario)</span>
<span class="c1"># the sell_extra variables refer to the amount of beets to be sold beyond the 6000 threshold, if any</span>

<span class="n">model</span><span class="o">.</span><span class="n">sell_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

<span class="n">model</span><span class="o">.</span><span class="n">sell_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">sell_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span>

<span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">first_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">total_H</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="n">total_M</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="n">total_L</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">total_H</span> <span class="o">+</span> <span class="n">total_M</span> <span class="o">+</span> <span class="n">total_L</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span>

<span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">second_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span>

<span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">total_profit</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">cbc_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solver status:** *</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solution:**&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(land allocation) $x_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action high yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action high yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action medium yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action medium yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action low yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action low yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Maximizes objective value to:** $</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Solver status:</strong> <em>ok, optimal</em></p>
<p><strong>Solution:</strong></p>
<p>(land allocation) $x_1 = 170.0$, $x_2 = 80.0$, $x_3 = 250.0$</p>
<p>(recourse sell action high yield) $w_1 = 310.0$, $w_2 = 48.0$, $w_3 = 6000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action high yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p>(recourse sell action medium yield) $w_1 = 225.0$, $w_2 = 0.0$, $w_3 = 5000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action medium yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p>(recourse sell action low yield) $w_1 = 140.0$, $w_2 = 0.0$, $w_3 = 4000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action low yield) $y_1 = 0.0$, $y_2 = 48.0$, $y_3 = 0.0$</p>
<p><strong>Maximizes objective value to:</strong> $108390$â‚¬</p>
</div>
</div>
<p>Please note a second way to create this model which makes use of <code class="docutils literal notranslate"><span class="pre">pyomo</span></code> <code class="docutils literal notranslate"><span class="pre">blocks</span></code>. For an explanation of <code class="docutils literal notranslate"><span class="pre">blocks</span></code> refer to chapter 8 of the <code class="docutils literal notranslate"><span class="pre">pyomo</span></code> book that you may <a class="reference external" href="https://vu.on.worldcat.org/oclc/988749903">download</a> from the VU library.</p>
<p>We leave as an exercise to redo the rest of the questions using <code class="docutils literal notranslate"><span class="pre">blocks</span></code> and see how that may help.</p>
<p>Note that for b) you will need to provide prices as parameters to the blocks.
Note as well that is the resolution below already had done that, instead of typing the prices as numerical constants, then the changes would have been immediate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="n">m</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">])</span>
<span class="n">m</span><span class="o">.</span><span class="n">totalacres</span> <span class="o">=</span> <span class="mi">500</span>

<span class="c1"># first stage variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

<span class="c1"># first stage constraint</span>
<span class="n">m</span><span class="o">.</span><span class="n">total_acres</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">summation</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">totalacres</span><span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">])</span>  <span class="c1"># high, medium, and low yield scenarios</span>

<span class="c1"># this could be a dataframe, or any other data source</span>
<span class="n">nominal_yields</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;W&#39;</span> <span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span> <span class="p">:</span>   <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span> <span class="p">:</span> <span class="mi">20</span> <span class="p">}</span>
<span class="n">factor_yields</span>  <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;M&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span> <span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span> <span class="p">:</span> <span class="mf">0.8</span> <span class="p">}</span>
<span class="n">m</span><span class="o">.</span><span class="n">yields</span> <span class="o">=</span> <span class="p">{</span> <span class="n">s</span> <span class="p">:</span> <span class="p">{</span> <span class="n">c</span> <span class="p">:</span> <span class="n">nominal_yields</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">factor_yields</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span> <span class="p">}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">scenario_block</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
  <span class="n">b</span><span class="o">.</span><span class="n">yields</span>     <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span><span class="n">initialize</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">yields</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
  <span class="n">b</span><span class="o">.</span><span class="n">sell</span>       <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
  <span class="n">b</span><span class="o">.</span><span class="n">buy</span>        <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
  <span class="n">b</span><span class="o">.</span><span class="n">sell_extra</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 
  <span class="n">b</span><span class="o">.</span><span class="n">sell_S</span>     <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
  <span class="n">b</span><span class="o">.</span><span class="n">nobuy</span>      <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">b</span><span class="o">.</span><span class="n">profit</span>     <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span> <span class="o">-</span><span class="mi">238</span><span class="o">*</span><span class="n">b</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">-</span><span class="mi">210</span><span class="o">*</span><span class="n">b</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span><span class="mi">36</span><span class="o">*</span><span class="n">b</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">b</span><span class="o">.</span><span class="n">sell_extra</span> <span class="o">+</span> <span class="mi">170</span><span class="o">*</span><span class="n">b</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">150</span><span class="o">*</span><span class="n">b</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">])</span>

<span class="n">m</span><span class="o">.</span><span class="n">scenario</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">scenario_block</span><span class="p">)</span>


<span class="c1"># second stage (linking) constraints</span>
<span class="n">m</span><span class="o">.</span><span class="n">feed_cattle_W</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">yields</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">feed_cattle_C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">yields</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell_S_extra</span>  <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">yields</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sell_extra</span> <span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span> <span class="n">expr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">150</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">-</span><span class="mi">230</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">-</span><span class="mi">260</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">total_expected_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span> <span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">profit</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span> <span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">cbc_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solver status:** *</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solution:**&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(land allocation) $x_1 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_2 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_3 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">spellout</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;H&#39;</span> <span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span> <span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span> <span class="p">:</span> <span class="s1">&#39;low&#39;</span> <span class="p">}</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
  <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action </span><span class="si">{</span><span class="n">spellout</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s2"> yield) $w_1 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sell_extra</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
  <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action </span><span class="si">{</span><span class="n">spellout</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s2"> yield) $y_1 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">scenario</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Maximizes objective value to:** $</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Solver status:</strong> <em>ok, optimal</em></p>
<p><strong>Solution:</strong></p>
<p>(land allocation) $x_1 = 170.0$, $x_2 = 80.0$, $x_3 = 250.0$</p>
<p>(recourse sell action high yield) $w_1 = 310.0$, $w_2 = 48.0$, $w_3 = 6000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action high yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p>(recourse sell action medium yield) $w_1 = 225.0$, $w_2 = 0.0$, $w_3 = 5000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action medium yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p>(recourse sell action low yield) $w_1 = 140.0$, $w_2 = 0.0$, $w_3 = 4000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action low yield) $y_1 = 0.0$, $y_2 = 48.0$, $y_3 = 0.0$</p>
<p><strong>Maximizes objective value to:</strong> $108390$â‚¬</p>
</div>
</div>
<p>If the weather is good and yields are high for the farmer, they are probably so also for many other farmers. The total supply is thus increasing, which will lower the prices. Assume the prices going down by 10% for corn and wheat when the weather is good and going up by 10% when the weather is bad. These changes in prices affect both sales and purchases of corn and wheat, but sugar beet prices are not affected by yields. The following table summarizes the scenario-dependent prices:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Scenario</p></th>
<th class="text-align:center head"><p>Selling price for weath</p></th>
<th class="text-align:center head"><p>Selling price for corn</p></th>
<th class="text-align:center head"><p>Purchasing price for weath</p></th>
<th class="text-align:center head"><p>Purchasing price for corn</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>Good weather</p></td>
<td class="text-align:center"><p>153</p></td>
<td class="text-align:center"><p>135</p></td>
<td class="text-align:center"><p>214</p></td>
<td class="text-align:center"><p>189</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Average weather</p></td>
<td class="text-align:center"><p>170</p></td>
<td class="text-align:center"><p>150</p></td>
<td class="text-align:center"><p>238</p></td>
<td class="text-align:center"><p>210</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>Bad weather</p></td>
<td class="text-align:center"><p>187</p></td>
<td class="text-align:center"><p>165</p></td>
<td class="text-align:center"><p>262</p></td>
<td class="text-align:center"><p>231</p></td>
</tr>
</tbody>
</table>
<p>(b) Implement the extensive form of stochastic LP corresponding to the farmerâ€™s problem in Pyomo that accounts also for the price changes and solve it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># scenario dependent parameters</span>
<span class="n">prices</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">},</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">},</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
    <span class="s2">&quot;B extra&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="c1"># mutable parameter</span>
<span class="n">m</span><span class="o">.</span><span class="n">total_acres</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># sets</span>
<span class="n">m</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">planting_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">m</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">yield_factor</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># constant parameter values</span>
<span class="n">m</span><span class="o">.</span><span class="n">planting_cost</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">planting_cost</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">crop_yield</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">crop_yield</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell_price</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">sell_price</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">buy_price</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">buy_price</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">demand</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">demand</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">cattle_feed</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">cattle_feed</span><span class="p">)</span>

<span class="c1"># scenario dependent parameter values</span>
<span class="n">m</span><span class="o">.</span><span class="n">yield_factor</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">yield_factor</span><span class="p">)</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">price_factor</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">prices</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>

<span class="c1"># first stage variables</span>

<span class="n">m</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># first stage constraint</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">acres</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">total_acres</span>

<span class="c1"># first stage profit</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Expression</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">planting_cost</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>

<span class="c1"># second stage variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">produced</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">buy</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">crops_produced</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">crop_yield</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">yield_factor</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">demand_limit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">cattle_feed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>

<span class="c1"># second stage profit</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">sell_price</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">price_factor</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span> 
    <span class="n">expense</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">buy_price</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">price_factor</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revenue</span> <span class="o">-</span> <span class="n">expense</span>

<span class="c1"># Objective</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">second_stage_profit</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>

<span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;cbc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First Stage Profit: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Crop       Planted&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">           (acres)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Second Stage / Recourse Solutions&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scenario </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> Profit: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">second_stage_profit</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Crop      Produced       Buy      Feed      Sell&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">            (tons)     (tons)    (tons)   (tons)&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
        <span class="n">sout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">cattle_feed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sout</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Expected profit = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">total_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First Stage Profit: -108900.00 euros
	Crop       Planted
	           (acres)
	W            170.0
	C             80.0
	B            250.0
	B extra        0.0

Second Stage / Recourse Solutions

Scenario H Profit: 269910.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            510.0       0.0     200.0     310.0
	C            288.0       0.0     240.0      48.0
	B           6000.0       0.0       0.0    6000.0
	B extra        0.0       0.0       0.0       0.0

Scenario M Profit: 218250.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            425.0       0.0     200.0     225.0
	C            240.0       0.0     240.0       0.0
	B           5000.0       0.0       0.0    5000.0
	B extra        0.0       0.0       0.0       0.0

Scenario L Profit: 159092.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            340.0       0.0     200.0     140.0
	C            192.0      48.0     240.0       0.0
	B           4000.0       0.0       0.0    4000.0
	B extra        0.0       0.0       0.0       0.0

Expected profit = 106850.67 euros
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">totalacres</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="c1"># to obtain the yields in the good weather (high yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># to obtain the yields in the bad weather (low yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="c1"># to obtain the prices in the good weather (high yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="c1"># to obtain the prices in the bad weather (low yield) case by multiplying the average ones</span>

<span class="c1"># first stage variables</span>
<span class="n">model</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

<span class="c1"># first stage constraint</span>
<span class="n">model</span><span class="o">.</span><span class="n">total_acres</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">summation</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">totalacres</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">])</span>  <span class="c1"># high, medium, and low yield scenarios</span>

<span class="c1"># second stage variables (labelled as H,M,L depending on the scenario)</span>
<span class="c1"># the sell_extra variables refer to the amount of beets to be sold beyond the 6000 threshold, if any</span>

<span class="n">model</span><span class="o">.</span><span class="n">sell_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

<span class="n">model</span><span class="o">.</span><span class="n">sell_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">sell_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span>

<span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">first_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">total_H</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span>
    <span class="n">total_M</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="n">total_L</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">total_H</span> <span class="o">+</span> <span class="n">total_M</span> <span class="o">+</span> <span class="n">total_L</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span>

<span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">second_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span>

<span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">total_profit</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">cbc_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solver status:** *</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solution:**&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(land allocation) $x_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action high yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action high yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action medium yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action medium yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action low yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action low yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Maximizes objective value to:** $</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Solver status:</strong> <em>ok, optimal</em></p>
<p><strong>Solution:</strong></p>
<p>(land allocation) $x_1 = 170.0$, $x_2 = 80.0$, $x_3 = 250.0$</p>
<p>(recourse sell action high yield) $w_1 = 310.0$, $w_2 = 48.0$, $w_3 = 6000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action high yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p>(recourse sell action medium yield) $w_1 = 225.0$, $w_2 = 0.0$, $w_3 = 5000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action medium yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p>(recourse sell action low yield) $w_1 = 140.0$, $w_2 = 0.0$, $w_3 = 4000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action low yield) $y_1 = 0.0$, $y_2 = 48.0$, $y_3 = 0.0$</p>
<p><strong>Maximizes objective value to:</strong> $106851$â‚¬</p>
</div>
</div>
</section>
<section id="c-discrete-first-stage-decisions">
<h2>(c) Discrete First-Stage Decisions<a class="headerlink" href="#c-discrete-first-stage-decisions" title="Permalink to this headline">#</a></h2>
<p>Consider again the case where prices are fixed and scenario-independent. The farmer possesses four fields of sizes <span class="math notranslate nohighlight">\(185\)</span>, <span class="math notranslate nohighlight">\(145\)</span>, <span class="math notranslate nohighlight">\(105\)</span>, and <span class="math notranslate nohighlight">\(65\)</span> acres, respectively. (observe that the total of 500 acres is unchanged). For reasons of efficiency the farmer wants to raise only one type of crop on each fields.</p>
<p>Formulate this model as a two-stage stochastic program with a first-stage program with binary variables and solve it using once more the extensive form of the same stochastic program.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">field_size</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">65</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="c1"># mutable parameter</span>
<span class="n">m</span><span class="o">.</span><span class="n">total_acres</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># sets</span>
<span class="n">m</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">planting_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">m</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">yield_factor</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">m</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">field_size</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># constant parameter values</span>
<span class="n">m</span><span class="o">.</span><span class="n">planting_cost</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">planting_cost</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">crop_yield</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">crop_yield</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell_price</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">sell_price</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">buy_price</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">buy_price</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">demand</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">demand</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">cattle_feed</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">cattle_feed</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">field_size</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">field_size</span><span class="p">)</span>

<span class="c1"># scenario dependent parameter values</span>
<span class="n">m</span><span class="o">.</span><span class="n">yield_factor</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">yield_factor</span><span class="p">)</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">price_factor</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.0</span>

<span class="c1"># first stage variables</span>

<span class="n">m</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">assign_field_to_crop</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span>

<span class="c1"># first stage constraint</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">plant_fields</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">assign_field_to_crop</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">field_size</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

<span class="c1"># assign only on crop to a field</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">assignment</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">assign_field_to_crop</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>

<span class="c1"># first stage profit</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Expression</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">planting_cost</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>

<span class="c1"># second stage variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">produced</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">buy</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">crops_produced</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">crop_yield</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">yield_factor</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">demand_limit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">cattle_feed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>

<span class="c1"># second stage profit</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">sell_price</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">price_factor</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span> 
    <span class="n">expense</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">buy_price</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">price_factor</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revenue</span> <span class="o">-</span> <span class="n">expense</span>

<span class="c1"># Objective</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">second_stage_profit</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>

<span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;cbc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First Stage Profit: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Crop       Planted&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">           (acres)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Field        Acres     Crop&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">            </span><span class="si">{</span><span class="n">field_size</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">assign_field_to_crop</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">]():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Second Stage / Recourse Solutions&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scenario </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> Profit: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">second_stage_profit</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Crop      Produced       Buy      Feed      Sell&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">            (tons)     (tons)    (tons)   (tons)&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
        <span class="n">sout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">cattle_feed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sout</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Expected profit = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">total_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First Stage Profit: -110900.00 euros
	Crop       Planted
	           (acres)
	W            145.0
	C            105.0
	B            250.0
	B extra        0.0

	Field        Acres     Crop
	1            185.0        B
	2            145.0        W
	3            105.0        C
	4             65.0        B

Second Stage / Recourse Solutions

Scenario H Profit: 276650.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            435.0       0.0     200.0     235.0
	C            378.0       0.0     240.0     138.0
	B           6000.0       0.0       0.0    6000.0
	B extra        0.0       0.0       0.0       0.0

Scenario M Profit: 218875.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            362.5       0.0     200.0     162.5
	C            315.0       0.0     240.0      75.0
	B           5000.0       0.0       0.0    5000.0
	B extra        0.0       0.0       0.0       0.0

Scenario L Profit: 161100.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            290.0       0.0     200.0      90.0
	C            252.0       0.0     240.0      12.0
	B           4000.0       0.0       0.0    4000.0
	B extra        0.0       0.0       0.0       0.0

Expected profit = 107975.00 euros
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fieldsize</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="mf">185.0</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mf">145.0</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="mf">105.0</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="mf">65.0</span><span class="p">},</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="c1"># to obtain the yields in the good weather (high yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># to obtain the yields in the bad weather (low yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># to obtain the prices in the good weather (high yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># to obtain the prices in the bad weather (low yield) case by multiplying the average ones</span>

<span class="c1"># first stage variables, which are now binary variables</span>
<span class="n">model</span><span class="o">.</span><span class="n">plant_W</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">plant_C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">plant_S</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span>

<span class="c1"># first stage constraint</span>
<span class="n">model</span><span class="o">.</span><span class="n">field1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">field2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">field3</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">field4</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># we recalculate the total surface per type of crop</span>
<span class="n">model</span><span class="o">.</span><span class="n">totalWsurface</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">fieldsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">fields</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">totalCsurface</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">fieldsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">fields</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">totalSsurface</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">fieldsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">fields</span><span class="p">]))</span>

<span class="n">model</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">])</span>  <span class="c1"># high, medium, and low yield scenarios</span>

<span class="c1"># second stage variables (labelled as H,M,L depending on the scenario)</span>
<span class="c1"># the sell_extra variables refer to the amount of beets to be sold beyond the 6000 threshold, if any</span>

<span class="n">model</span><span class="o">.</span><span class="n">sell_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

<span class="n">model</span><span class="o">.</span><span class="n">sell_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">sell_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalWsurface</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalCsurface</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalSsurface</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalWsurface</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalCsurface</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalSsurface</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalWsurface</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalCsurface</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalSsurface</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">totalWsurface</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">totalCsurface</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">totalSsurface</span> <span class="o">*</span> <span class="mi">260</span>

<span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">first_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">total_H</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span>
    <span class="n">total_M</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="n">total_L</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">total_H</span> <span class="o">+</span> <span class="n">total_M</span> <span class="o">+</span> <span class="n">total_L</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span>

<span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">second_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span>

<span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">total_profit</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">cbc_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solver status:** *</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solution:**&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(wheat field allocation) $[</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_W</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">]$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(corn field allocation) $[</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_C</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">]$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(beet field allocation) $[</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant_S</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">]$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(land field allocation) $x_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">totalWsurface</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">totalCsurface</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">totalSsurface</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action high yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action high yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action medium yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action medium yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action low yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action low yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Maximizes objective value to:** $</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Solver status:</strong> <em>ok, optimal</em></p>
<p><strong>Solution:</strong></p>
<p>(wheat field allocation) $[0, 1, 0, 0]$</p>
<p>(corn field allocation) $[0, 0, 1, 0]$</p>
<p>(beet field allocation) $[1, 0, 0, 1]$</p>
<p>(land field allocation) $x_1 = 145.0$, $x_2 = 105.0$, $x_3 = 250.0$</p>
<p>(recourse sell action high yield) $w_1 = 235.0$, $w_2 = 138.0$, $w_3 = 6000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action high yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p>(recourse sell action medium yield) $w_1 = 162.5$, $w_2 = 75.0$, $w_3 = 5000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action medium yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p>(recourse sell action low yield) $w_1 = 90.0$, $w_2 = 12.0$, $w_3 = 4000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action low yield) $y_1 = 0.0$, $y_2 = 0.0$, $y_3 = 0.0$</p>
<p><strong>Maximizes objective value to:</strong> $107975$â‚¬</p>
</div>
</div>
</section>
<section id="d-risk-averse-farmer">
<h2>(d) Risk Averse Farmer<a class="headerlink" href="#d-risk-averse-farmer" title="Permalink to this headline">#</a></h2>
<p>Consider again the setting described in (a). The farmer would normally act as a risk-averse person and simply plan for the worst case. More precisely, the farmer maximizes her profit under the worst scenario, that is the bad weather one.</p>
<p>(d) Solve the deterministic LP for the bad weather scenario to find the corresponding worst-case optimal land allocation. Using this land allocation, compute the loss in expected profit if that solution is taken.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="c1"># mutable parameter</span>
<span class="n">m</span><span class="o">.</span><span class="n">total_acres</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># sets</span>
<span class="n">m</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">planting_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">m</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">yield_factor</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># constant parameter values</span>
<span class="n">m</span><span class="o">.</span><span class="n">planting_cost</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">planting_cost</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">crop_yield</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">crop_yield</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell_price</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">sell_price</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">buy_price</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">buy_price</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">demand</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">demand</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">cattle_feed</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">cattle_feed</span><span class="p">)</span>

<span class="c1"># scenario dependent parameter values</span>
<span class="n">m</span><span class="o">.</span><span class="n">yield_factor</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">yield_factor</span><span class="p">)</span>

<span class="c1"># first stage variables</span>

<span class="n">m</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># first stage constraint</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">acres</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">total_acres</span>

<span class="c1"># first stage profit</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Expression</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">planting_cost</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>

<span class="c1"># second stage variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">produced</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">buy</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">sell</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">crops_produced</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">crop_yield</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">yield_factor</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">demand_limit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">cattle_feed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>

<span class="c1"># second stage profit</span>
<span class="nd">@m</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">sell_price</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span> 
    <span class="n">expense</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">buy_price</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revenue</span> <span class="o">-</span> <span class="n">expense</span>

<span class="c1"># Objective</span>
<span class="n">m</span><span class="o">.</span><span class="n">worst_case_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">worst_case</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">worst_case_profit</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">second_stage_profit</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> 

<span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">worst_case_profit</span>

<span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;cbc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First Stage Profit: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">first_stage_profit</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Crop       Planted&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">           (acres)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Second Stage / Recourse Solutions&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scenario </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> Profit: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">second_stage_profit</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Crop      Produced       Buy      Feed      Sell&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">            (tons)     (tons)    (tons)   (tons)&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">crops</span><span class="p">:</span>
        <span class="n">sout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">produced</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">cattle_feed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sout</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">7.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sout</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Worst Case Profit = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">total_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> euros&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First Stage Profit: -110500.00 euros
	Crop       Planted
	           (acres)
	W            150.0
	C            100.0
	B            250.0
	B extra        0.0

Second Stage / Recourse Solutions

Scenario H Profit: 276500.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            450.0       0.0     200.0     250.0
	C            360.0       0.0     240.0     120.0
	B           6000.0       0.0       0.0    6000.0
	B extra        0.0       0.0       0.0       0.0

Scenario M Profit: 218750.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            375.0       0.0     200.0     175.0
	C            300.0       0.0     240.0      60.0
	B           5000.0       0.0       0.0    5000.0
	B extra        0.0       0.0       0.0       0.0

Scenario L Profit: 161000.00 euros
	Crop      Produced       Buy      Feed      Sell
	            (tons)     (tons)    (tons)   (tons)
	W            300.0       0.0     200.0     100.0
	C            240.0       0.0     240.0       0.0
	B           4000.0       0.0       0.0    4000.0
	B extra        0.0       0.0       0.0       0.0

Worst Case Profit = 50500.00 euros
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bad weather only</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">totalacres</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="c1"># to obtain the yields in the good weather (high yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># to obtain the yields in the bad weather (low yield) case by multiplying the average ones</span>

<span class="c1"># first stage variables</span>
<span class="n">model</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

<span class="c1"># first stage constraint</span>
<span class="n">model</span><span class="o">.</span><span class="n">total_acres</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">summation</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">totalacres</span><span class="p">)</span>

<span class="c1"># second stage variables</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span>

<span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">first_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>

<span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">second_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span>

<span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">total_profit</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">cbc_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solver status:** *</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solution:**&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(land allocation) $x_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action low yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action low yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Maximizes objective value to:** $</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Solver status:</strong> <em>ok, optimal</em></p>
<p><strong>Solution:</strong></p>
<p>(land allocation) $x_1 = 100.0$, $x_2 = 25.0$, $x_3 = 375.0$</p>
<p>(recourse sell action low yield) $w_1 = 0.0$, $w_2 = 0.0$, $w_3 = 6000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action low yield) $y_1 = 0.0$, $y_2 = 180.0$, $y_3 = 0.0$</p>
<p><strong>Maximizes objective value to:</strong> $59950$â‚¬</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Expected profit when optimizing only against bad weather </span>
<span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="c1"># to obtain the yields in the good weather (high yield) case by multiplying the average ones</span>
<span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># to obtain the yields in the bad weather (low yield) case by multiplying the average ones</span>

<span class="c1"># first stage variables are now parameters, since we set them equal to the optimal allocation for bad weather calculated in the previous cell</span>
<span class="n">model</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mi">375</span><span class="p">})</span> 

<span class="n">model</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">])</span>  <span class="c1"># high, medium, and low yield scenarios</span>

<span class="c1"># second stage variables (labelled as H,M,L depending on the scenario)</span>
<span class="c1"># the sell_extra variables refer to the amount of beets to be sold beyond the 6000 threshold, if any</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

<span class="n">model</span><span class="o">.</span><span class="n">sell_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">sell_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">buy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1"># second stage constraints</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">sell_S_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">nobuy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span>

<span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">first_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">total_H</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="n">total_M</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="n">total_L</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">total_H</span> <span class="o">+</span> <span class="n">total_M</span> <span class="o">+</span> <span class="n">total_L</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span>

<span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">second_stage_profit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span>

<span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">total_profit</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">cbc_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solver status:** *</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Solution:**&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(land allocation) $x_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $x_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action high yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action high yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action medium yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action medium yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse sell action low yield) $w_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $w_4 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(recourse purchase action low yield) $y_1 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_2 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$, $y_3 = </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Maximizes objective value to:** $</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Solver status:</strong> <em>ok, optimal</em></p>
<p><strong>Solution:</strong></p>
<p>(land allocation) $x_1 = 100.0$, $x_2 = 25.0$, $x_3 = 375.0$</p>
<p>(recourse sell action high yield) $w_1 = 100.0$, $w_2 = 0.0$, $w_3 = 6000.0$, $w_4 = 3000.0$</p>
<p>(recourse purchase action high yield) $y_1 = 0.0$, $y_2 = 150.0$, $y_3 = 0.0$</p>
<p>(recourse sell action medium yield) $w_1 = 50.0$, $w_2 = 0.0$, $w_3 = 6000.0$, $w_4 = 1500.0$</p>
<p>(recourse purchase action medium yield) $y_1 = 0.0$, $y_2 = 165.0$, $y_3 = 0.0$</p>
<p>(recourse sell action low yield) $w_1 = 0.0$, $w_2 = 0.0$, $w_3 = 6000.0$, $w_4 = 0.0$</p>
<p>(recourse purchase action low yield) $y_1 = 0.0$, $y_2 = 180.0$, $y_3 = 0.0$</p>
<p><strong>Maximizes objective value to:</strong> $86600$â‚¬</p>
</div>
</div>
<p>(e) A different approach situation be to require a reasonable minimum profit under the worst case. Find the solution that maximizes the expected profit under the constraint that in the worst case the profit does not fall below <span class="math notranslate nohighlight">\(58.000\)</span> euro. What is now the loss in expected profit?</p>
<p>Repeat the same optimization also with other values of minimal profit: <span class="math notranslate nohighlight">\(56.000\)</span>, <span class="math notranslate nohighlight">\(54.000\)</span>, <span class="math notranslate nohighlight">\(52.000\)</span>, <span class="math notranslate nohighlight">\(50.000\)</span>, and <span class="math notranslate nohighlight">\(48.000\)</span> euro. Graph the curve of expected profit loss and compare the associated optimal decisions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expectedprofit_noconstraints</span> <span class="o">=</span> <span class="mi">108390</span>

<span class="k">def</span> <span class="nf">FarmersWithMinimumProfit</span><span class="p">(</span><span class="n">minprofit</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">crops</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">totalacres</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="c1"># to obtain the yields in the good weather (high yield) case by multiplying the average ones</span>
    <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># to obtain the yields in the bad weather (low yield) case by multiplying the average ones</span>
    <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># to obtain the prices in the good weather (high yield) case by multiplying the average ones</span>
    <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># to obtain the prices in the bad weather (low yield) case by multiplying the average ones</span>

    <span class="c1"># first stage variables</span>
    <span class="n">model</span><span class="o">.</span><span class="n">plant</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

    <span class="c1"># first stage constraint</span>
    <span class="n">model</span><span class="o">.</span><span class="n">total_acres</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">summation</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">totalacres</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">])</span>  <span class="c1"># high, medium, and low yield scenarios</span>

    <span class="c1"># second stage variables (labelled as H,M,L depending on the scenario)</span>
    <span class="c1"># the sell_extra variables refer to the amount of beets to be sold beyond the 6000 threshold, if any</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> 

    <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># second stage constraints</span>
    <span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_H</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_S_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">nobuy_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_S_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">nobuy_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_W_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">feed_cattle_C_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_S_extra_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">factor_L</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sell_S_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">nobuy_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">first_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span>

    <span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">first_stage_profit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">second_stage_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">total_H</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span>
        <span class="n">total_M</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span>
        <span class="n">total_L</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">total_H</span> <span class="o">+</span> <span class="n">total_M</span> <span class="o">+</span> <span class="n">total_L</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span>

    <span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">second_stage_profit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">total_profit</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">first_stage_profit</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">second_stage_profit</span>

    <span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">total_profit</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">totalprofit_H</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_H</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_H</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">totalprofit_M</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_M</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_M</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">totalprofit_L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">230</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">plant</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">260</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">buy_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_extra_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">sell_L</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">pricefactor_L</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">minimum_profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">totalprofit_L</span> <span class="o">&gt;=</span> <span class="n">minprofit</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cbc_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Minimum profit threshold** of $</span><span class="si">{</span><span class="n">minprofit</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬ leads to an **optimal expected profit** of $</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬, with a **loss** of $</span><span class="si">{</span><span class="n">expectedprofit_noconstraints</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$â‚¬&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">total_expected_profit</span><span class="p">()</span>

<span class="n">profitthresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">48000</span><span class="p">,</span><span class="mi">50000</span><span class="p">,</span><span class="mi">52000</span><span class="p">,</span><span class="mi">54000</span><span class="p">,</span><span class="mi">56000</span><span class="p">,</span><span class="mi">58000</span><span class="p">]</span>
<span class="k">for</span> <span class="n">minprofit</span> <span class="ow">in</span> <span class="n">profitthresholds</span><span class="p">:</span>
    <span class="n">FarmersWithMinimumProfit</span><span class="p">(</span><span class="n">minprofit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Minimum profit threshold</strong> of $48000$â‚¬ leads to an <strong>optimal expected profit</strong> of $108390$â‚¬, with a <strong>loss</strong> of $0$â‚¬</p>
<p><strong>Minimum profit threshold</strong> of $50000$â‚¬ leads to an <strong>optimal expected profit</strong> of $108292$â‚¬, with a <strong>loss</strong> of $98$â‚¬</p>
<p><strong>Minimum profit threshold</strong> of $52000$â‚¬ leads to an <strong>optimal expected profit</strong> of $107976$â‚¬, with a <strong>loss</strong> of $414$â‚¬</p>
<p><strong>Minimum profit threshold</strong> of $54000$â‚¬ leads to an <strong>optimal expected profit</strong> of $107611$â‚¬, with a <strong>loss</strong> of $779$â‚¬</p>
<p><strong>Minimum profit threshold</strong> of $56000$â‚¬ leads to an <strong>optimal expected profit</strong> of $107246$â‚¬, with a <strong>loss</strong> of $1144$â‚¬</p>
<p><strong>Minimum profit threshold</strong> of $58000$â‚¬ leads to an <strong>optimal expected profit</strong> of $101176$â‚¬, with a <strong>loss</strong> of $7214$â‚¬</p>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/10"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="airline-seating.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Airline seat allocation problem</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../../pyomo_style_guide.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Pyomo Style Guide</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The MO Book Group<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>